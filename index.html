<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–æ–≤</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="container">
    <h1>üé¨ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–æ–≤</h1>
    <p class="sub">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî –ø–æ–ª—É—á–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –ø–æ—Å—Ç–µ—Ä–∞–º–∏.</p>
  </header>

  <main class="container">
    <section class="controls">
      <label>
        –ñ–∞–Ω—Ä
        <input id="genre" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–æ–º–µ–¥–∏—è, –¥—Ä–∞–º–∞, –±–æ–µ–≤–∏–∫" />
      </label>

      <label class="rating">
        –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥: <span id="ratingValue">0.0</span>
        <input id="minRating" type="range" min="0" max="10" step="0.5" value="0" />
      </label>

      <button id="searchBtn">–ù–∞–π—Ç–∏ —Ñ–∏–ª—å–º—ã</button>
    </section>

    <section id="results" class="grid"></section>

    <nav id="pager" class="pager hidden">
      <button id="prevBtn" disabled>¬´ –ù–∞–∑–∞–¥</button>
      <span id="pageInfo"></span>
      <button id="nextBtn">–í–ø–µ—Ä—ë–¥ ¬ª</button>
    </nav>
  </main>

  <footer class="container foot">
    <small>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: kinopoisk.dev ¬∑ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</small>
  </footer>

  <script>
    const BACKEND_BASE_URL = "https://film-recomendator.onrender.com/"
    const genreInput = document.getElementById('genre');
    const ratingInput = document.getElementById('minRating');
    const ratingValue = document.getElementById('ratingValue');
    const searchBtn = document.getElementById('searchBtn');
    const resultsEl = document.getElementById('results');
    const pagerEl = document.getElementById('pager');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');

    let currentPage = 1;
    let totalPages = 1;
    let lastQuery = { genre: "", minRating: 0 };

    ratingInput.addEventListener('input', () => {
      ratingValue.textContent = Number(ratingInput.value).toFixed(1);
    });

    searchBtn.addEventListener('click', () => {
      currentPage = 1;
      search();
    });
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; search(); }
    });
    nextBtn.addEventListener('click', () => {
      if (currentPage < totalPages) { currentPage++; search(); }
    });

    async function search() {
      const genre = genreInput.value.trim();
      const minRating = Number(ratingInput.value);
      lastQuery = { genre, minRating };

      if (!genre) {
        resultsEl.innerHTML = `<div class="empty">–í–≤–µ–¥–∏—Ç–µ –∂–∞–Ω—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–æ–º–µ–¥–∏—è)</div>`;
        pagerEl.classList.add('hidden');
        return;
      }

      resultsEl.innerHTML = `<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å–º–æ–≤‚Ä¶</div>`;

      const url = new URL(`${BACKEND_BASE_URL}/movies`);
      url.searchParams.set('genre', genre);
      url.searchParams.set('min_rating', minRating);
      url.searchParams.set('page', currentPage);
      url.searchParams.set('limit', 20);

      try {
        const resp = await fetch(url.toString());
        if (!resp.ok) throw new Error(`–û—à–∏–±–∫–∞ API: ${resp.status}`);
        const data = await resp.json();

        totalPages = data.pages || 1;
        renderResults(data.items || []);
        renderPager();
      } catch (e) {
        resultsEl.innerHTML = `<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª—å–º—ã: ${e.message}</div>`;
        pagerEl.classList.add('hidden');
      }
    }

    function renderResults(items) {
      if (!items.length) {
        resultsEl.innerHTML = `<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∂–∞–Ω—Ä –∏–ª–∏ —Å–Ω–∏–∑—å—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥.</div>`;
        return;
      }
      resultsEl.innerHTML = items.map(cardHTML).join('');
    }

    function cardHTML(m) {
      const poster = m.poster || 'https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞';
      const name = escapeHTML(m.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
      const desc = escapeHTML(m.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
      const year = m.year ? ` ¬∑ ${m.year}` : '';
      const rating = (m.rating || m.rating === 0) ? `–†–µ–π—Ç–∏–Ω–≥: ${m.rating}` : '–†–µ–π—Ç–∏–Ω–≥: ‚Äî';
      const genres = (m.genres && m.genres.length) ? m.genres.join(', ') : '';
      const more = m.url ? `<a href="${m.url}" target="_blank" rel="noopener">–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ñ–∏–ª—å–º–∞</a>` : '';

      return `
        <article class="card">
          <img src="${poster}" alt="–ü–æ—Å—Ç–µ—Ä: ${name}" loading="lazy"/>
          <div class="meta">
            <h3>${name}<span class="muted">${year}</span></h3>
            <p class="muted">${genres}</p>
            <p>${desc}</p>
            <div class="row">
              <span class="badge">${rating}</span>
              ${more}
            </div>
          </div>
        </article>
      `;
    }

    function renderPager() {
      pagerEl.classList.remove('hidden');
      pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // –ù–µ–±–æ–ª—å—à–æ–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
    genreInput.value = "–∫–æ–º–µ–¥–∏—è";
    ratingInput.value = 6.5; ratingValue.textContent = "6.5";
    search();
  </script>
</body>
</html>
