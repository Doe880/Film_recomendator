<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–æ–≤</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="container">
    <h1>üé¨ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–æ–≤</h1>
    <p class="sub">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä, —Å—Ç—Ä–∞–Ω—É, –≥–æ–¥ –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –ø–æ—Å—Ç–µ—Ä–∞–º–∏.</p>
  </header>

  <main class="container">
    <section class="controls">
      <label>
        –ñ–∞–Ω—Ä
        <select id="genre">
          <option value="–∫–æ–º–µ–¥–∏—è">–ö–æ–º–µ–¥–∏—è</option>
          <option value="–¥—Ä–∞–º–∞">–î—Ä–∞–º–∞</option>
          <option value="–±–æ–µ–≤–∏–∫">–ë–æ–µ–≤–∏–∫</option>
          <option value="—Ç—Ä–∏–ª–ª–µ—Ä">–¢—Ä–∏–ª–ª–µ—Ä</option>
          <option value="—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞">–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
          <option value="—Ñ—ç–Ω—Ç–µ–∑–∏">–§—ç–Ω—Ç–µ–∑–∏</option>
          <option value="–∫—Ä–∏–º–∏–Ω–∞–ª">–ö—Ä–∏–º–∏–Ω–∞–ª</option>
          <option value="–º–µ–ª–æ–¥—Ä–∞–º–∞">–ú–µ–ª–æ–¥—Ä–∞–º–∞</option>
          <option value="—É–∂–∞—Å—ã">–£–∂–∞—Å—ã</option>
          <option value="–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è">–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</option>
          <option value="–∞–Ω–∏–º–µ">–ê–Ω–∏–º–µ</option>
          <option value="—Å–µ–º–µ–π–Ω—ã–π">–°–µ–º–µ–π–Ω—ã–π</option>
          <option value="–∏—Å—Ç–æ—Ä–∏—è">–ò—Å—Ç–æ—Ä–∏—è</option>
          <option value="–±–∏–æ–≥—Ä–∞—Ñ–∏—è">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</option>
          <option value="–¥–µ—Ç–µ–∫—Ç–∏–≤">–î–µ—Ç–µ–∫—Ç–∏–≤</option>
        </select>
      </label>

      <label>
        –°—Ç—Ä–∞–Ω–∞
        <select id="country">
          <option value="">–õ—é–±–∞—è</option>
          <option value="–†–æ—Å—Å–∏—è">–†–æ—Å—Å–∏—è</option>
          <option value="–°–®–ê">–°–®–ê</option>
          <option value="–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è">–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</option>
          <option value="–§—Ä–∞–Ω—Ü–∏—è">–§—Ä–∞–Ω—Ü–∏—è</option>
          <option value="–ì–µ—Ä–º–∞–Ω–∏—è">–ì–µ—Ä–º–∞–Ω–∏—è</option>
          <option value="–Ø–ø–æ–Ω–∏—è">–Ø–ø–æ–Ω–∏—è</option>
          <option value="–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è">–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è</option>
          <option value="–ò–Ω–¥–∏—è">–ò–Ω–¥–∏—è</option>
          <option value="–ò—Ç–∞–ª–∏—è">–ò—Ç–∞–ª–∏—è</option>
          <option value="–ò—Å–ø–∞–Ω–∏—è">–ò—Å–ø–∞–Ω–∏—è</option>
          <option value="–ö–∏—Ç–∞–π">–ö–∏—Ç–∞–π</option>
          <option value="–ö–∞–Ω–∞–¥–∞">–ö–∞–Ω–∞–¥–∞</option>
        </select>
      </label>

      <label>
        –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ (—Ç–æ—á–Ω–æ)
        <input id="year" type="number" min="1888" max="2100" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 2020" />
      </label>

      <label class="rating">
        –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥: <span id="ratingValue">0.0</span>
        <input id="minRating" type="range" min="0" max="10" step="0.5" value="0" />
      </label>

      <button id="searchBtn">–ù–∞–π—Ç–∏ —Ñ–∏–ª—å–º—ã</button>
    </section>

    <section id="results" class="grid"></section>

    <nav id="pager" class="pager hidden">
      <button id="prevBtn" disabled>¬´ –ù–∞–∑–∞–¥</button>
      <span id="pageInfo"></span>
      <button id="nextBtn">–í–ø–µ—Ä—ë–¥ ¬ª</button>
    </nav>
  </main>

  <footer class="container foot">
    <small>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: kinopoisk.dev ¬∑ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</small>
  </footer>

  <script>
    // –£–ö–ê–ñ–ò URL —Å–≤–æ–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (–º–æ–∂–Ω–æ —Å / –Ω–∞ –∫–æ–Ω—Ü–µ ‚Äî –º—ã —Å–∫–ª–µ–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ):
    const BACKEND_BASE_URL = "https://film-recomendator.onrender.com/";

    const genreSelect = document.getElementById('genre');
    const countrySelect = document.getElementById('country');
    const yearInput = document.getElementById('year');
    const ratingInput = document.getElementById('minRating');
    const ratingValue = document.getElementById('ratingValue');
    const searchBtn = document.getElementById('searchBtn');
    const resultsEl = document.getElementById('results');
    const pagerEl = document.getElementById('pager');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');

    let currentPage = 1;
    let totalPages = 1;

    ratingInput.addEventListener('input', () => {
      ratingValue.textContent = Number(ratingInput.value).toFixed(1);
    });

    searchBtn.addEventListener('click', () => {
      currentPage = 1;
      search();
    });
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; search(); }
    });
    nextBtn.addEventListener('click', () => {
      if (currentPage < totalPages) { currentPage++; search(); }
    });

    async function search() {
      const genre = genreSelect.value;
      const minRating = Number(ratingInput.value);
      const country = countrySelect.value;
      const year = yearInput.value.trim();

      if (!genre) {
        resultsEl.innerHTML = `<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</div>`;
        pagerEl.classList.add('hidden');
        return;
      }

      resultsEl.innerHTML = `<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å–º–æ–≤‚Ä¶</div>`;

      // –°–∫–ª–µ–∏–≤–∞–µ–º –ø—É—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ //movies
      const url = new URL('/movies', BACKEND_BASE_URL);
      url.searchParams.set('genre', genre);
      url.searchParams.set('min_rating', minRating);
      url.searchParams.set('page', currentPage);
      url.searchParams.set('limit', 20);
      if (country) url.searchParams.set('country', country);
      if (year) url.searchParams.set('year', parseInt(year, 10));

      try {
        const resp = await fetch(url.toString());
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`–û—à–∏–±–∫–∞ API (${resp.status}): ${text}`);
        }
        const data = await resp.json();

        totalPages = data.pages || 1;
        renderResults(data.items || []);
        renderPager();
      } catch (e) {
        resultsEl.innerHTML = `<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª—å–º—ã: ${escapeHTML(e.message)}</div>`;
        pagerEl.classList.add('hidden');
      }
    }

    function renderResults(items) {
      if (!items.length) {
        resultsEl.innerHTML = `<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Å–ª–∞–±–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</div>`;
        return;
      }
      resultsEl.innerHTML = items.map(cardHTML).join('');
    }

    function cardHTML(m) {
      const poster = m.poster || 'https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞';
      const name = escapeHTML(m.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
      const desc = escapeHTML(m.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
      const year = m.year ? ` ¬∑ ${m.year}` : '';
      const rating = (m.rating || m.rating === 0) ? `–†–µ–π—Ç–∏–Ω–≥: ${m.rating}` : '–†–µ–π—Ç–∏–Ω–≥: ‚Äî';
      const genres = (m.genres && m.genres.length) ? m.genres.join(', ') : '';
      const more = m.url ? `<a href="${m.url}" target="_blank" rel="noopener">–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ñ–∏–ª—å–º–∞</a>` : '';

      return `
        <article class="card">
          <img src="${poster}" alt="–ü–æ—Å—Ç–µ—Ä: ${name}" loading="lazy"/>
          <div class="meta">
            <h3>${name}<span class="muted">${year}</span></h3>
            <p class="muted">${genres}</p>
            <p>${desc}</p>
            <div class="row">
              <span class="badge">${rating}</span>
              ${more}
            </div>
          </div>
        </article>
      `;
    }

    function renderPager() {
      pagerEl.classList.remove('hidden');
      pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    genreSelect.value = "–∫–æ–º–µ–¥–∏—è";
    countrySelect.value = "";
    ratingInput.value = 6.5; ratingValue.textContent = "6.5";
    yearInput.value = "";
    search();
  </script>
</body>
</html>
